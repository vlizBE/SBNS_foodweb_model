---
title: "Temperature_Env-Resp"
author: "Dries Lorr√© and Renee Kelem"
date: "2024-10-22"
output: html_document
---
In this script, the average monthly temperature data is linked to the environmental response of each functional group in the EwE model of the Southern Bight of the North Sea (SBNS). Average monthly foraging response is calculated. For EwE input a representative compensation temperature is calculated for each year.


# Load required libraries
```{r, echo = FALSE}
library(ggplot2)
library(dplyr)
```

# Read data
```{r}
Var_resp <- read.csv("Sal_Ecosim_format_DL_CC_adapted.csv") 
# For temperature select: "Temp_Ecosim_format_DL_CC_adapted.csv"
# For salinity select: "Sal_Ecosim_format_DL_CC_adapted.csv"

################################################################
#####  # => ADJUST DEPENDING ON SCENARIO ALSO ADJUST ########

### TEMPERATURE
# var_m <- read.csv("SST_SSP3-7.0_monthly_1991_2099.csv") #%>%
  # filter(Year<2024)

# "SST_SSP1-2.6_monthly_1991_2099.csv"
# "SST_SSP2-4.5_monthly_1991_2099.csv"
# "SST_SSP3-7.0_monthly_1991_2099.csv"

### SALINITY
var_m <- read.csv("SSS_SSP3-7.0_monthly_1991_2099.csv") #%>%
  # filter(Year<2024)

# "SSS_SSP1-2.6_monthly_1991_2099.csv"
# "SSS_SSP2-4.5_monthly_1991_2099.csv"
# "SSS_SSP3-7.0_monthly_1991_2099.csv"
```
First, add column Temperature to Var_resp to enable look-up of monthly temperatures: minimum value = 0, maximum value = 40 (This was done manually in Excel)
Next, link observed monthly temperature to environmental response (foraging compensation) of each species.
```{r}
# Loop through each species to interpolate responses
species_names <- colnames(Var_resp)[c(4:39)]  # Get all species column names, excluding "variable" and "row number"

# Add columns for each species to var_m (initializing with NA for now)
species_response_time_series <- var_m

# Add empty columns for each species
for (species in species_names) {
  species_response_time_series[[species]] <- NA_real_
}

for (species in species_names) {
  # Use approx() for linear interpolation of species response
  interpolated_responses <- approx(Var_resp$variable, Var_resp[[species]], var_m$variable)$y
  
  # Add the interpolated responses to the var_m dataframe
  species_response_time_series[[species]] <- interpolated_responses
}

# Now species_response_time_series contains the var_m time series with the interpolated species responses.
```

Now, the average yearly response can be calculated and linked to a proper compensation temperature (a temperature that yields the average environmental response for that species in the given year)
```{r}
yearly_average_response <- species_response_time_series %>%
  group_by(Year) %>%
  summarise(across(all_of(species_names), mean, na.rm = TRUE))
# write.csv(yearly_average_response, "y_avg_resp_EwE_fitting_V1.csv")

yearly_average_response_bymonths <- yearly_average_response %>% slice(rep(1:n(), each = 12))
write.csv(yearly_average_response_bymonths, #"TEMP_avg_resp_EwE_forcing_HISTORICAL.csv")
# "TEMP_avg_resp_EwE_forcing_SSP1_2.6.csv")
# "TEMP_avg_resp_EwE_forcing_SSP2_4.5.csv")
# "TEMP_avg_resp_EwE_forcing_SSP3_7.0.csv")

# "SAL_avg_resp_EwE_forcing_HISTORICAL.csv")
# "SAL_avg_resp_EwE_forcing_SSP1_2.6.csv")
# "SAL_avg_resp_EwE_forcing_SSP2_4.5.csv")
"SAL_avg_resp_EwE_forcing_SSP3_7.0.csv")


```


